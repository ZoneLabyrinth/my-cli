#!/usr/bin/env node

//æ ¸å¿ƒå¤„ç†å‘½ä»¤è¡Œ
const program = require('commander')
//æ¸å˜è‰²è¾“å‡º
const Printer = require('@darkobits/lolcatjs')
//shellå‘½ä»¤
const shelljs = require('shelljs')
//ç”¨æˆ·äº¤äº’
const inquirer = require('inquirer')
//ç”¨æˆ·å¯¹è¯ï¼Œè½¬æ¢é¢œè‰²
const chalk = require('chalk')
//loadingæ¨¡å—
const ora = require('ora')
//éœ€è¦å‡†å¤‡çš„æœ«ç­æ–‡ä»¶
const template = "direct:https://github.com/ZoneLabyrinth/my-spa.git"
//ä¸“é—¨å»ä¸‹è½½gitç›®å½•
const download = require('download-git-repo')
//è·å–ç”¨æˆ·çš„ç›®å½•
const userHome = require('user-home')


const input = [
    "____            _     _   _ ",
    "|  _ \\    __ _  | |_  | | | |",
    "| |_) |  / _` | | __| | |_| |",
    "|  __/  | (_| | | |_  |  _  |",
    "|_|      \\__,_|  \\__| |_| |_|"

].join('\n')

program.version(Printer.default.fromString("0.0.1\n," + input), "-V,--version");

// éœ€è¦cli-initæ–‡ä»¶
// program.command('init', "åˆå§‹åŒ–é¡¹ç›®");

const bindHandler = {
    init() {
        inquirer
            .prompt([
                {
                    type: "input",
                    message: 'project-name',
                    name: 'dirname',
                    default:'my-project',
                },
                {
                    type: "list",
                    message: "è¯·é€‰æ‹©æ¡†æ¶",
                    choices: ["âœ” my-spa", "âœ” vue", "âœ” react"],
                    name: "kind"
                }
            ])
            .then(answers => {
                // Use user feedback for... whatever!!
                const _dirname = answers.dirname;

                const _kind = answers.kind;
                let templateURL, name;

                switch (_kind) {
                    case "âœ” my-spa":
                        templateURL = template;
                        name = 'my-spa'
                        break;
                    case "âœ” vue":
                        //TODO vueæ¨¡æ¿
                        // templateURL = 
                        console.log("å°šæœªå¼€å‘vueæ¨¡æ¿")
                        process.exit(1);
                        break;
                    case "âœ” react":
                        templateURL = "direct:https://github.com/ZoneLabyrinth/react-mobile.git"
                        name = 'react-mobile'
                        break;
                }


                if (_dirname) {
                    const spinner = ora('Downloading template... \n');
                    spinner.start();
                    console.log(Printer.default.fromString(input))
                    //åˆ›å»ºæ–‡ä»¶å¤¹
                    const _projectPath = `${userHome}/Desktop/${_dirname}`
                    shelljs.cd(`${userHome}/Desktop/`);
                    shelljs.rm("-rf", _projectPath);
                    shelljs.mkdir(_dirname);

                    //ä¸‹è½½é¡¹ç›®
                    //The repository parameter defaults to the master branch, but you can specify a branch or tag as a URL fragment like owner/name#my-branch. 
                    //In addition to specifying the type of where to download, you can also specify a custom origin like 
                    /**
                     * @param {url} Direct ä¸‹è½½è·¯å¾„
                     * @param {string} destination ç›®æ ‡æ–‡ä»¶å
                     * @param {object} options ä¸‹è½½å‚æ•° {clone:true}ä½¿ç”¨clone ä»£æ›¿ httpä¸‹è½½;å…¶ä»–å‚æ•°(proxy,headers,filter...)
                     * @param {function} callback å›è°ƒå‡½æ•° é”™è¯¯å¤„ç†
                     */
                    download(templateURL, _projectPath, { clone: true }, err => {
                        spinner.stop();
                        if (err) {
                            console.error('ä¸‹è½½å¤±è´¥', err.message.trim())
                        } else {
                            //æŠŠç”¨æˆ·æ•´ä½“å®‰è£…è¿‡çš„é¡¹ç›®è¿›è¡Œæ ¸å¿ƒæ•°æ®æ›¿æ¢ï¼ˆä¿®æ”¹package.jsonä¸­nameï¼‰
                            shelljs.sed("-i", name, _dirname, _projectPath + "/package.json")
                            console.log(chalk.green("The project was created successfully "))
                        }
                    })
                }

            });
    }
}

program
    .usage("[cmd] <options>")
    .arguments("<cmd> [env]")
    .action((cmd, otherParms) => {
        const handler = bindHandler[cmd]
        if (typeof handler === "undefined") {
            console.log(`${chalk.red("Unknown option")} ${chalk.yellow(cmd)}ï¼Œè¯·æ£€æŸ¥è¾“å…¥å‘½ä»¤ğŸŒº \n\n`)
            program.help()
        } else {
            handler(otherParms)
        }
    })

program.parse(process.argv)